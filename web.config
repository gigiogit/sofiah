<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>
    <security>
      <requestFiltering>
        <hiddenSegments>
          <remove segment="bin" />
        </hiddenSegments>
      </requestFiltering>
    </security>
    <httpErrors existingResponse="PassThrough" />
        <rewrite>
            <rules>
                <!-- Servir arquivos estáticos diretamente (EXCETO uploads) -->
                <rule name="StaticFiles" stopProcessing="true">
                    <match url=".*\.(jpg|jpeg|png|gif|svg|pdf|doc|docx|txt|css|js|ico|woff|woff2|ttf|eot)$" />
                    <conditions>
                        <add input="{REQUEST_FILENAME}" matchType="IsFile" />
                        <!-- NÃO aplicar para pasta uploads -->
                        <add input="{REQUEST_URI}" pattern="^/uploads/" negate="true" />
                    </conditions>
                    <action type="None" />
                </rule>
                <!-- Redirecionar uploads para Next.js (para arquivos dinâmicos) -->
                <rule name="UploadsToNextJS" stopProcessing="true">
                    <match url="^uploads/(.*)$" />
                    <action type="Rewrite" url="http://localhost:9998/api/{R:0}" />
                </rule>
                <!-- Redirecionar todo o resto para Next.js -->
                <rule name="ReverseProxyInboundRule1" stopProcessing="true">
                    <match url="(.*)" />
                    <action type="Rewrite" url="http://localhost:9998/{R:1}" />
                </rule>
            </rules>
        </rewrite>
  </system.webServer>
</configuration>